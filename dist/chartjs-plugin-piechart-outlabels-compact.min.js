/*!
 * chartjs-plugin-piechart-outlabels-compact
 * http://chartjs.org/
 * Version: 0.1.3
 *
 * Copyright 2020 Neckster
 * Released under the MIT license
 * https://github.com/Neckster/chartjs-plugin-piechart-outlabels-compact/blob/master/LICENSE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],e):e(t.Chart)}(this,function(t){"use strict";function e(t,e){var i=t.outlabels,h={};return i===!1?null:(i===!0&&(i={}),s.merge(h,[e,i]))}t=t&&t.hasOwnProperty("default")?t["default"]:t;var i=t.helpers,s=i.merge(i,{toFontString:function(t){return!t||i.isNullOrUndef(t.size)||i.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family},textSize:function(t,e,i){var s,h=[].concat(e),r=h.length,l=t.font,o=0;for(t.font=i.string,s=0;s<r;++s)o=Math.max(t.measureText(h[s]).width,o);return t.font=l,{height:r*i.lineHeight,width:o}},parseFont:function(e,s){var h=t.defaults.global,r=i.valueOrDefault(e.size,h.defaultFontSize);e.resizable&&(r=this.adaptTextSizeToHeight(s,e.minSize,e.maxSize));var l={family:i.valueOrDefault(e.family,h.defaultFontFamily),lineHeight:i.options.toLineHeight(e.lineHeight,r),size:r,style:i.valueOrDefault(e.style,h.defaultFontStyle),weight:i.valueOrDefault(e.weight,null),string:""};return l.string=i.toFontString(l),l},adaptTextSizeToHeight:function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}}),h={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,text:"%l %p",zoomOutPercentage:50,percentPrecision:2,valuePrecision:3,compactStyle:!1},r={init:function(){Math.trunc||(Math.trunc=function(t){return t=+t,t-t%1||(isFinite(t)&&0!==t?t<0?-0:0:t)}),Chart.defaults.outlabeledDoughnut=Chart.defaults.doughnut,Chart.defaults.outlabeledPie=Chart.defaults.pie;var t=function(t){Chart.controllers.doughnut.prototype.update.call(this);var e=this,i=e.getMeta(),s=e.chart.options.zoomOutPercentage||h.zoomOutPercentage;e.outerRadius*=1-s/100,e.innerRadius*=1-s/100,Chart.helpers.each(i.data,function(i,s){e.updateElement(i,s,t)})},e=Chart.controllers.doughnut.extend({update:t}),i=Chart.controllers.pie.extend({update:t});Chart.controllers.outlabeledPie=i,Chart.controllers.outlabeledDoughnut=e}},l={center:function(t,e,i){var s=(t.startAngle+t.endAngle)/2,h=Math.cos(s),r=Math.sin(s),l=t.outerRadius;i&&(l*=.75);var o=l+e;return{x:t.x+h*o,y:t.y+r*o,d:o,arc:t,anchor:{x:t.x+h*l,y:t.y+r*l},copy:{x:t.x+h*o,y:t.y+r*o}}},moveFromAnchor:function(t,e){var i=t.arc,s=t.d,h=(i.startAngle+i.endAngle)/2,r=Math.cos(h),l=Math.sin(h);return s+=e,{x:i.x+r*s,y:i.y+l*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+r*s,y:i.y+l*s}}}},o=t.helpers,n=h.LABEL_KEY,a={OutLabel:function(e,i,s,r,a){var c=t.helpers.options.resolve;if(!c([r.display,!0],a,i))throw new Error("Label display property is set to false.");var d=a.dataset.data[i],f=a.labels[i],u=c([r.text,h.text],a,i);u=u.replace(/%l/gi,f),(u.match(/%v\.?(\d*)/gi)||[]).map(function(t){return r.valuePrecision||h.valuePrecision}).forEach(function(t){u=u.replace(/%v\.?(\d*)/i,d.toFixed(t))}),(u.match(/%p\.?(\d*)/gi)||[]).map(function(t){return r.percentPrecision||h.percentPrecision}).forEach(function(t){u=u.replace(/%p\.?(\d*)/i,(100*a.percent).toFixed(t)+"%")});var x=u.match(/[^\r\n]+/g);if(!x||!x.length)throw new Error("No text to show.");for(var y=0;y<x.length;++y)x[y]=x[y].trim();this.init=function(t,l){this.encodedText=r.text,this.text=t,this.lines=l,this.label=f,this.value=d,this.ctx=s,this.style={backgroundColor:c([r.backgroundColor,h.backgroundColor,"black"],a,i),borderColor:c([r.borderColor,h.borderColor,"black"],a,i),borderRadius:c([r.borderRadius,0],a,i),borderWidth:c([r.borderWidth,0],a,i),lineWidth:c([r.lineWidth,2],a,i),lineColor:c([r.lineColor,h.lineColor,"black"],a,i),color:c([r.color,"white"],a,i),font:o.parseFont(c([r.font,{resizable:!0}]),s.canvas.style.height.slice(0,-2)),padding:o.options.toPadding(c([r.padding,0],a,i)),textAlign:c([r.textAlign,"left"],a,i)},this.compactStyle=c([r.compactStyle,h.compactStyle,!1],a,i),this.stretch=c([r.stretch,40],a,i),this.size=o.textSize(s,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.compactStyle?this.offset={x:this.size.width/2,y:-this.size.height/2-this.style.padding.bottom-this.style.borderWidth}:this.offset={x:0,y:0},this.predictedOffset=this.offset;var n=-((e._model.startAngle+e._model.endAngle)/2)/Math.PI,u=Math.abs(n-Math.trunc(n));u>.45&&u<.55?(this.predictedOffset.x=0,this.compactStyle&&(this.predictedOffset.x=this.size.width/2+this.style.padding.left+this.style.borderWidth)):n<=.45&&n>=-.45?(this.predictedOffset.x=this.size.width/2,this.compactStyle&&(this.predictedOffset.x+=this.style.padding.left+this.style.borderWidth)):n>=-1.45&&n<=-.55&&(this.predictedOffset.x=-this.size.width/2,this.compactStyle&&(this.predictedOffset.x-=this.style.padding.left+this.style.borderWidth))},this.init(u,x),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth,e=this.textRect.height+2*this.style.borderWidth,i=this.textRect.x-this.style.padding.left-this.style.borderWidth,s=this.textRect.y-this.style.padding.top-this.style.borderWidth;return t+=this.style.padding.width,e+=this.style.padding.height,{x:i,y:s,width:t,height:e}},this.computeTextRect=function(){return{x:this.center.x-this.size.width/2,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,h=this.style.font,r=h.lineHeight,l=this.style.color,o=this.lines.length;if(o&&l)for(t=this.textRect.x,e=this.textRect.y+r/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=l,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<o;++i)this.ctx.fillText(this.lines[i],Math.round(t),Math.round(e),Math.round(this.textRect.width)),e+=r},this.drawLabel=function(){if(s.beginPath(),this.compactStyle){var t=Math.round(this.labelRect.x),e=Math.round(this.labelRect.y)+Math.round(this.labelRect.height);this.ctx.moveTo(t,e),this.ctx.lineTo(t+Math.round(this.labelRect.width),e)}else o.canvas.roundedRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius);this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.drawLine=function(){var t=3;this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.fillStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.compactStyle&&(this.ctx.beginPath(),this.ctx.arc(this.center.anchor.x,this.center.anchor.y,t,0,2*Math.PI),this.ctx.stroke(),this.ctx.fill(),this.ctx.closePath()),this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=l.center(t,this.stretch,this.compactStyle),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var s=!1;!s;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var h=this.getPoints();s=!0;for(var r=0;r<i;++r){var o=e[r][n];if(o)for(var a=o.getPoints(),c=0;c<h.length;++c){if(o.containsPoint(h[c])){s=!1;break}if(this.containsPoint(a[c])){s=!1;break}}}s||(this.center=l.moveFromAnchor(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}}};r.init(),t.defaults.global.plugins.outlabels=h;var c=h.LABEL_KEY;t.plugins.register({id:"outlabels",resize:function(t,e,i){t.sizeChanged=!0},afterDatasetUpdate:function(t,i,s){var h,r,l,o,n,d,f=t.config.data.labels,u=t.data.datasets[i.index],x=e(u,s),y=x&&x.display,g=i.meta.data||[],b=t.ctx;for(b.save(),d=0;d<g.length;++d){if(h=g[d],r=h[c],l=u.data[d]/i.meta.total,o=null,y&&h&&!h.hidden)try{n={chart:t,dataIndex:d,dataset:u,labels:f,datasetIndex:i.index,percent:l},o=new a.OutLabel(h,d,b,x,n)}catch(p){o=null}r&&o&&!t.sizeChanged&&r.label===o.label&&r.encodedText===o.encodedText&&(o.offset=r.offset),h[c]=o}b.restore(),t.sizeChanged=!1},afterDatasetDraw:function(t,e){for(var i,s,h,r=e.meta.data||[],l=t.ctx,o=0;o<2*r.length;++o)h=o<r.length?o:o-r.length,i=r[h],s=i[c],s&&(o<r.length?(s.update(i._view,r,o),s.drawLine(l)):s.draw(l))}})});